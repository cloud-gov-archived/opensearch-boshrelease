#!/bin/bash

set -e
set -x

export JOB_NAME=opensearch
export JOB_DIR=/var/vcap/jobs/$JOB_NAME
export REQUESTS_CA_BUNDLE="/etc/ssl/certs/ca-certificates.crt"

<% if p('opensearch.repository.s3.bucket') != '' and p('opensearch.node.allow_cluster_manager') and spec.bootstrap %>
curl -X PUT \
  --key ${JOB_DIR}/config/ssl/opensearch-admin.key \
  --cert ${JOB_DIR}/config/ssl/opensearch-admin.crt  \
  --cacert ${JOB_DIR}/config/ssl/opensearch.ca \
  -s https://localhost:9200/_snapshot/<%= p('opensearch.repository.name') %> \
  -H 'Content-Type: application/json' \
  -d '{"type": "s3", "settings": {"bucket": "<%= p('opensearch.repository.s3.bucket') %>"}}'
<% end %>

<% if p('opensearch.path_repo') != '' and p('opensearch.node.allow_cluster_manager') and spec.bootstrap %>
curl -X PUT \
  --key ${JOB_DIR}/config/ssl/opensearch-admin.key \
  --cert ${JOB_DIR}/config/ssl/opensearch-admin.crt  \
  --cacert ${JOB_DIR}/config/ssl/opensearch.ca \
  -s https://localhost:9200/_snapshot/<%= p('opensearch.repository.name') %> \
  -H 'Content-Type: application/json' \
  -d '{"type": "fs", "settings": {"location": "<%= p('opensearch.path_repo') %>/<%= p('opensearch.repository.name') %>", "compress": true}}'
<% end %>


<% if p('opensearch.notification.host') != '' %>
BASE64_USERNAME="<%= p('opensearch.notification.username') %>" | base64
BASE64_PASSWORD="<%= p('opensearch.notification.password') %>" | base64
/var/vcap/packages/opensearch/bin/opensearch-keystore remove opensearch.notifications.core.email.cloudgovemail.username
/var/vcap/packages/opensearch/bin/opensearch-keystore remove opensearch.notifications.core.email.cloudgovemail.password
/var/vcap/packages/opensearch/bin/opensearch-keystore remove notifications.email.cloudgovemail.smtp_user
/var/vcap/packages/opensearch/bin/opensearch-keystore remove notifications.email.cloudgovemail.smtp_password
echo -n ${BASE64_USERNAME} | yes | /var/vcap/packages/opensearch/bin/opensearch-keystore add opensearch.notifications.core.email.cloudgovemail.username
echo -n ${BASE64_PASSWORD} | yes | /var/vcap/packages/opensearch/bin/opensearch-keystore add opensearch.notifications.core.email.cloudgovemail.password
echo -n ${BASE64_USERNAME} | yes | /var/vcap/packages/opensearch/bin/opensearch-keystore add notifications.email.cloudgovemail.smtp_user
echo -n ${BASE64_PASSWORD} | yes | /var/vcap/packages/opensearch/bin/opensearch-keystore add notifications.email.cloudgovemail.smtp_password
curl -X POST \
  --key ${JOB_DIR}/config/ssl/opensearch-admin.key \
  --cert ${JOB_DIR}/config/ssl/opensearch-admin.crt  \
  --cacert ${JOB_DIR}/config/ssl/opensearch.ca \
  https://localhost:9200/_plugins/_notifications/configs \
  -H 'Content-Type: application/json' \
  -d '{"config_id": "cloudgov-smtp-id","name": "cloud-gov-smtp","config":{"config_type": "smtp_account","name": "cloudgovemail","description":"SMTP account default for cloud.gov","feature_list": ["alerting"],"is_enabled": true,"smtp_account":{"host": "<%= p('opensearch.notification.host') %>","port": <%= p('opensearch.notification.port') %>,"method":"start_tls","from_address": "<%= p('opensearch.notification.from') %>"}}}'
<% end %>