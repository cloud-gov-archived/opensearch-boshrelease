#!/usr/bin/env bash

set -e

# shellcheck disable=1091
source /var/vcap/packages/golang-1.21-linux/bosh/runtime.env

export GOPATH=/var/vcap/packages/smoke-tests
export PATH=${GOPATH}/bin:${GOROOT}/bin:/var/vcap/packages/cf-cli-7-linux/bin:${PATH}

export CF_COLOR=false
export CONFIG=/var/vcap/jobs/smoke-tests/bin/config.json

cd /var/vcap/packages/smoke-tests/src/github.com/cloudfoundry-community/logsearch-smoke-tests
go mod init
echo "Running smoke tests..."

EXITSTATUS=0

test (){
set -e
set -x
export CGO_ENABLED=0
go install -v github.com/onsi/ginkgo/ginkgo@latest

CGO_ENABLED=0 CF_COLOR=false CF_VERBOSE_OUTPUT=true ginkgo smoke -r -v -noColor=true -keepGoing=true -trace=true -slowSpecThreshold=300
}
test || EXITSTATUS=$?

echo "Smoke Tests Complete; exit status: $EXITSTATUS"
exit $EXITSTATUS
